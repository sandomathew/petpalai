{# petfood_analyzer/templates/petfood_analyzer/upload.html #}

{% extends "base.html" %} {# Extend your project-level base template #}
{% load static %} {# Load static files if you use them here (e.g., custom CSS/JS for this page) #}

{% block title %}Analyze Pet Food Label{% endblock %}

{% block content %}
    <h2>Upload Pet Food Label for Analysis</h2>

    {% if error_message %}
        <div class="alert alert-danger" role="alert">{{ error_message }}</div>
    {% endif %}

    <form id="upload-form" method="post"
          enctype="multipart/form-data" class="mb-4 p-4 border rounded shadow-sm"
          data-stream-url-base="{% url 'stream_data' task_id='_task_id_' %}">
        {% csrf_token %} {# Django's security token for forms #}

        {% for field in form %}
            <div class="mb-3">
                {{ field.label_tag }}
                {{ field }}
                {% if field.help_text %}
                    <div class="form-text text-muted">{{ field.help_text }}</div>
                {% endif %}
                {% for error in field.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                {% endfor %}
            </div>
        {% endfor %}

        <button type="submit" id="submit-button" class="btn btn-primary">Analyze Label</button>
    </form>

    <div id="results-container"></div>
    <div id="status-message"></div>

   {% if food_scan %}
        <div class="card mt-4 shadow-sm">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0">Analysis Results for "{{ food_scan.product_name|default:"Unnamed Product" }}"</h3>
            </div>
            <div class="card-body">
                <p class="card-text"><strong>Food Type:</strong> {{ food_scan.get_food_type_display }}</p>
                <p class="card-text"><strong>Scanned At:</strong> {{ food_scan.scanned_at|date:"M d, Y H:i" }}</p>

                <h4 class="mt-4">Uploaded Image:</h4>
                {% if food_scan.image %}
                    <img src="{{ food_scan.image.url }}" alt="Uploaded Label" class="img-fluid rounded border" style="max-height: 400px; object-fit: contain;">
                {% else %}
                    <p>No image available.</p>
                {% endif %}

                <h4 class="mt-4">Raw Text (OCR):</h4>
                <pre class="p-3 bg-light border rounded">{{ food_scan.raw_text|default:"No text extracted." }}</pre>

                <h4 class="mt-4">Parsed Nutritional Data:</h4>
                {% if food_scan.parsed_data %}
                    <pre style="display: none;" id="parsed_data_raw">{{ food_scan.parsed_data|json_script:"parsed_data" }}</pre>
                    <div id="parsed-data-display" class="p-3 bg-light border rounded"></div>
                    <script>
                        const dataElement = document.getElementById('parsed_data_raw');
                        if (dataElement) {
                            const data = JSON.parse(dataElement.textContent);
                            document.getElementById('parsed-data-display').innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                        }
                    </script>
                {% else %}
                    <p>No parsed data available.</p>
                {% endif %}

                {% if food_scan.calorie_content_kcal_per_kg or food_scan.calorie_content_per_unit %}
                    <h4 class="mt-4">Calorie Content:</h4>
                    {% if food_scan.calorie_content_kcal_per_kg %}
                        <p><strong>kcal ME/kg:</strong> {{ food_scan.calorie_content_kcal_per_kg }}</p>
                    {% endif %}
                    {% if food_scan.calorie_content_per_unit %}
                        <p><strong>Per Unit:</strong> {{ food_scan.calorie_content_per_unit }}</p>
                    {% endif %}
                {% endif %}


                <h4 class="mt-4">AI-Generated Pros & Cons:</h4>
                <div class="p-3 bg-light border rounded" style="white-space: pre-wrap;">{{ food_scan.ai_analysis|default:"No AI analysis generated yet." }}</div>

            </div>
        </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('upload-form');
        const submitButton = document.getElementById('submit-button');
        const typingMsg = document.getElementById("typing-indicator");
        const resultsContainer = document.getElementById('results-container');
        const statusMessage = document.getElementById('status-message');
        const msgtxt = document.getElementById('msg-txt');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const startUrl = "{% url 'start_stream_analysis' %}";

        form.addEventListener('submit', function(event) {
            event.preventDefault();

            // Show loading state
            ShowLoadingState();

            const formData = new FormData(form);

            fetch(startUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'processing' && data.task_id) {
                    const streamUrl = form.dataset.streamUrlBase.replace('_task_id_', data.task_id);
                    const source = new EventSource(streamUrl);

                    source.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    updateStatusMessage(data.message);
                    if (data.status === 'ocr_complete') {
                        // Display OCR text immediately
                        resultsContainer.innerHTML += `<h4>Raw Text (OCR):</h4><pre class="p-3 bg-light border rounded">${data.raw_text}</pre>`;
                    } else if (data.status === 'llm_complete') {
                        // Display LLM output
                        resultsContainer.innerHTML += `<h4>AI-Generated Pros & Cons:</h4><div class="p-3 bg-light border rounded" style="white-space: pre-wrap;">${data.ai_analysis}</div>`;
                        source.close(); // Close the connection
                        hideLoadingState();
                    } else if (data.status === 'error') {
                        displayError(data.message);
                        source.close();
                    }
                    };

                    source.onerror = function(error) {
                        console.error('EventSource failed:', error);
                        source.close();
                        displayError("Streaming failed. Please try again.");
                         hideLoadingState();
                    };
            } else {
                    displayError(data.message || 'An unexpected error occurred.');
                    hideLoadingState();
                    }
            })
            .catch(error => {
                console.error('Fetch failed:', error);
                displayError("Submission failed. " + error.message);
                hideLoadingState();
            });
        });

        // Processing helper functions
        function ShowLoadingState() {
            submitButton.disabled = true;
            submitButton.textContent = 'Analyzing...';
            resultsContainer.innerHTML = '';
            statusMessage.textContent = '';
            // Clear previous content and animation if it exists
            const existingContainer = document.getElementById('typing-container');
            if (existingContainer) {
                existingContainer.remove();
            }
            const typingContainer = document.createElement('div');
            typingContainer.id = "typing-container";

            const typingMsg = document.createElement('div');
            typingMsg.className = "chat-message agent typing";
            typingMsg.innerHTML = `
                <span class="agent-avatar">
                    <img src="/static/images/paai_trim1.jpg" alt="PAAI avatar">
                </span>
                <div class="status-and-animation">
                    <div id="status-text"></div>
                    <div class="typing-animation">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            typingMsg.id = "typing-indicator";
            typingContainer.appendChild(typingMsg);

            statusMessage.appendChild(typingContainer);
        }

        function hideLoadingState() {
            submitButton.disabled = false;
            submitButton.textContent = 'Analyze Label';
            const typingContainer = document.getElementById('typing-container');
            if (typingContainer) {
                typingContainer.remove();
            }
        }

        // Function to update the message text
        function updateStatusMessage(message) {
            const statusTextDiv = document.getElementById('status-text');
            if (statusTextDiv) {
                statusTextDiv.textContent = message;
            }
        }

        function displayOcr(rawText) {
            resultsContainer.innerHTML += `<h4>Raw Text (OCR):</h4><pre class="p-3 bg-light border rounded">${rawText || 'No text extracted.'}</pre>`;
        }

        function displayLlmOutput(aiAnalysis) {
            resultsContainer.innerHTML += `<h4>AI-Generated Pros & Cons:</h4><div class="p-3 bg-light border rounded" style="white-space: pre-wrap;">${aiAnalysis || 'No AI analysis generated yet.'}</div>`;
        }

        function displayError(message) {
            // Hide loading state
            hideLoadingState();
            // Display the error message
            resultsContainer.innerHTML = `<div class="alert alert-danger" role="alert">${message}</div>`;
        }
    });
    </script>
{% endblock %}